{
  "hash": "a6a94d9707a9909f9b6bdf4ef10e153d",
  "result": {
    "markdown": "---\ntitle: \"hydrowaste\"\nsubtitle: \"Tidy Tuesday, 2021-01-05\"\nauthor: \"Juha Päällysaho\"\ndate: \"2023-04-18\"\ndate-modified: \"2024-01-15\"\nexecute:\n  echo: true\n  warning: false\ndraft: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(skimr)\n```\n:::\n\n\nthis is tidytuesday data on wastewater treatment plants\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(2022, week = 38)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDownloading file 1 of 1: `HydroWASTE_v10.csv`\n```\n:::\n\n```{.r .cell-code}\ntuesdata\ndf_raw <- tuesdata |>\n  pluck(1) |>\n  type_convert() |>\n  janitor::clean_names()\n```\n:::\n\n\nthe data has country locations, longitude/latitude,countries, population served, waste water discharge levels, location from coastal areas and is the waste treatment plant at designed quantity level. The plants have different statuses from closed to operational.\n\npossible business questions:\n- which countries have the highest waste water discharge levels? If we thing about financial support on water treatment plants, which countries should we focus on to get highest impact? - what countries has the worst water treatment plants per capita? This linked to impact value of possible monetary support. \n- the presence of coastal areas information in the data is also interesting to approach the problem from the perspective of water quality and marine life.  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_raw |> skim()\n```\n\n::: {.cell-output-display}\nTable: Data summary\n\n|                         |       |\n|:------------------------|:------|\n|Name                     |df_raw |\n|Number of rows           |58502  |\n|Number of columns        |25     |\n|_______________________  |       |\n|Column type frequency:   |       |\n|character                |5      |\n|numeric                  |20     |\n|________________________ |       |\n|Group variables          |None   |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|wwtp_name     |      5290|          0.91|   1| 202|     0|    49233|          0|\n|country       |         0|          1.00|   4|  32|     0|      188|          0|\n|cntry_iso     |         0|          1.00|   3|   3|     0|      180|          0|\n|status        |         0|          1.00|   6|  22|     0|        9|          0|\n|level         |         0|          1.00|   7|   9|     0|        3|          0|\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|          mean|           sd|          p0|         p25|         p50|          p75|         p100|hist  |\n|:-------------|---------:|-------------:|-------------:|------------:|-----------:|-----------:|-----------:|------------:|------------:|:-----|\n|waste_id      |         0|          1.00|      29251.50| 1.688822e+04|        1.00|    14626.25|    29251.50| 4.387675e+04| 5.850200e+04|▇▇▇▇▇ |\n|source        |         0|          1.00|          3.25| 3.390000e+00|        1.00|        1.00|        2.00| 4.000000e+00| 1.200000e+01|▇▁▁▁▁ |\n|org_id        |         0|          1.00| 7594239906.92| 1.502416e+10|        1.00|     4000.25|  1296386.50| 1.000290e+09| 7.800000e+10|▇▁▁▁▁ |\n|lat_wwtp      |         0|          1.00|         35.13| 2.244000e+01|      -54.79|       33.49|       41.72| 4.846000e+01| 7.164000e+01|▁▁▁▇▅ |\n|lon_wwtp      |         0|          1.00|        -14.64| 6.753000e+01|     -175.30|      -81.64|        2.15| 1.665000e+01| 1.784800e+02|▁▆▇▁▁ |\n|qual_loc      |         0|          1.00|          2.03| 6.400000e-01|        1.00|        2.00|        2.00| 2.000000e+00| 4.000000e+00|▂▇▁▁▁ |\n|lat_out       |         0|          1.00|         35.13| 2.244000e+01|      -54.80|       33.48|       41.71| 4.846000e+01| 7.164000e+01|▁▁▁▇▅ |\n|lon_out       |         0|          1.00|        -14.64| 6.753000e+01|     -175.30|      -81.63|        2.16| 1.668000e+01| 1.784300e+02|▁▆▇▁▁ |\n|pop_served    |         0|          1.00|      39273.73| 1.536832e+05|        0.00|     1388.00|     4613.50| 1.991100e+04| 1.014613e+07|▇▁▁▁▁ |\n|qual_pop      |         0|          1.00|          1.99| 9.500000e-01|        1.00|        1.00|        2.00| 2.000000e+00| 4.000000e+00|▆▇▁▂▂ |\n|waste_dis     |         0|          1.00|       8916.56| 4.468567e+04|        0.00|      340.69|     1079.00| 4.428930e+03| 3.073754e+06|▇▁▁▁▁ |\n|qual_waste    |         0|          1.00|          2.22| 1.450000e+00|        1.00|        1.00|        1.00| 4.000000e+00| 4.000000e+00|▇▁▁▁▆ |\n|qual_level    |         0|          1.00|          1.19| 3.900000e-01|        1.00|        1.00|        1.00| 1.000000e+00| 2.000000e+00|▇▁▁▁▂ |\n|df            |     11200|          0.81|     279284.87| 7.460834e+06|        1.00|      105.88|      569.62| 3.784690e+03| 7.029366e+08|▇▁▁▁▁ |\n|hyriv_id      |       379|          0.99|   41913715.43| 2.329755e+07| 10000009.00| 20409188.00| 40182395.00| 7.049991e+07| 8.032324e+07|▇▁▂▁▆ |\n|river_dis     |     10551|          0.82|        391.84| 5.173560e+03|        0.00|        1.72|        6.54| 3.797000e+01| 1.271052e+05|▇▁▁▁▁ |\n|coast_10km    |         0|          1.00|          0.18| 3.800000e-01|        0.00|        0.00|        0.00| 0.000000e+00| 1.000000e+00|▇▁▁▁▂ |\n|coast_50km    |         0|          1.00|          0.33| 4.700000e-01|        0.00|        0.00|        0.00| 1.000000e+00| 1.000000e+00|▇▁▁▁▃ |\n|design_cap    |     15835|          0.73|      23981.77| 1.215321e+05|        0.00|     1022.06|     4200.00| 1.409900e+04| 1.120625e+07|▇▁▁▁▁ |\n|qual_cap      |         0|          1.00|          1.96| 7.600000e-01|        1.00|        1.00|        2.00| 3.000000e+00| 3.000000e+00|▆▁▇▁▅ |\n:::\n:::\n\n\n\n\n# etl\n\nwaste_dis and pop_served has 0 values which can skew eda metrics later on. I will replace them with NA values. continent is parsed from iso3c code with contrycode package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df_raw |>\n  mutate(\n    # replace waste_dis and pop_server 0 with NA\n    across(c(waste_dis, pop_served), ~ na_if(., 0))\n  ) |>\n  mutate(\n    waste_ratio = waste_dis / pop_served,\n    continent = countrycode::countrycode(cntry_iso, \"iso3c\", \"continent\"),\n    .before = 1\n  )\n```\n:::\n\n\n# eda\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontinents_agg <- df |>\n  summarise(\n    plants = n(),\n    avg_pop_served = mean(pop_served, na.rm = T), ,\n    avg_disposal = mean(waste_dis, na.rm = T),\n    avg_waste_ratio = mean(waste_ratio, na.rm = T),\n    .by = c(continent)\n  ) |>\n  arrange(-plants) |>\n  filter(!is.na(continent))\n```\n:::\n\n\nAmericas and africa have larger average wastewater distarge per capita compared to Europe and Asia.\nwhat is the industry standard for wastewater discharge per capita?\n\n::: {.cell}\n\n```{.r .cell-code}\ncontinents_agg\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 5\n  continent plants avg_pop_served avg_disposal avg_waste_ratio\n  <chr>      <int>          <dbl>        <dbl>           <dbl>\n1 Europe     26971         25893.        5198.           0.231\n2 Americas   22926         22577.        7583.           0.549\n3 Asia        5503        175878.       33705.           0.280\n4 Oceania     1578         12945.        3572.           0.326\n5 Africa      1518         79821.       14530.           4.47 \n```\n:::\n:::\n\n\n# level and continent\n\nis there difference on plant level and continent?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplant_levels <- df |>\n  summarise(\n    n = n(),\n    avg_waste_ratio = mean(waste_ratio, na.rm = T),\n    .by = c(continent, level)\n    # ratio = n / total\n  ) |>\n  arrange(-n)\n```\n:::\n\n\nmost of the advanced plants are in Europe and Asia. Africa has the most plants in the basic level.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplant_levels |>\n  ggplot(aes(continent, n, fill = level)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplant_levels |>\n  ggplot(aes(continent, avg_waste_ratio, fill = level)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\neurope and africa seems to have outliers in waste discharge per capita.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  # ggplot avg_pop_served and avg_wastewater_disposal\n  ggplot(aes(waste_ratio, continent, color = level)) +\n  geom_jitter(alpha = 0.5) +\n  scale_x_log10() +\n  labs(\n    title = \"waste water discharge per capita\",\n    subtitle = \"waste water discharge per capita by continent and level\",\n    caption = \"data: tidytuesdayR::hydrowaste\",\n    x = \"waste water discharge per capita\",\n    y = \"continent\"\n  )\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n# plants close to coast\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot coast_10km with waste_ratio\ndf |>\n  ggplot(aes(level, waste_ratio, color = as_factor(coast_10km))) +\n  geom_jitter(alpha = 0.5) +\n  scale_y_log10() +\n  labs(\n    title = \"waste water discharge per capita\",\n    subtitle = \"waste water discharge per capita by distance to coast and level\",\n    color = \"Coast, 10km\",\n    x = \"distance to coast\",\n    y = \"waste water discharge per capita\"\n  )\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n# waste water plants in Finland\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  filter(country == \"Finland\") |>\n  summarize(avg_waste_ratio = mean(waste_ratio, na.rm = T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 1\n  avg_waste_ratio\n            <dbl>\n1           0.164\n```\n:::\n:::\n\n\nhttps://evamaerey.github.io/flipbooks/geom_sf/geom_sf.html#50\n\nbelow is a map of waste water treatment plants in Finland. The color of the points is the waste ratio, which is the waste discharge per capita. The darker the color, the higher the waste discharge per capita. The map shows that the waste discharge per capita is higher in the south of Finland, which is the most populated area.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(rnaturalearth)\n\nfi <- ne_countries(\n  scale = \"medium\", returnclass = \"sf\"\n) %>%\n  select(name, continent, geometry) %>%\n  filter(name == \"Finland\")\n\ndf |>\n  filter(country == \"Finland\") |>\n  # View()\n  st_as_sf(coords = c(\"lon_wwtp\", \"lat_wwtp\"), crs = 4326, remove = FALSE) |>\n  ggplot() +\n  geom_sf(data = fi) +\n  geom_point(aes(lon_wwtp, lat_wwtp, color = waste_ratio), alpha = .7, size = 2) +\n  scale_color_viridis_c()\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n# model\n\nwhat describers the waste discharge per capita?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\ntidymodels_prefer()\n```\n:::\n\n\n# pca to understand the variance\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_pca <- df |>\n  recipe(waste_ratio ~ .) |>\n  step_select(-c(wwtp_name, status, waste_id, source, org_id, df, ends_with(\"wwtp\"), ends_with(\"out\"))) |>\n  step_impute_mean(all_numeric_predictors()) |>\n  step_normalize(all_numeric_predictors()) |>\n  step_pca(all_numeric_predictors(), num_comp = 3) |>\n  prep()\n```\n:::\n\n\n- first qual_ component seems to be data quality layer, which has minimal impact on the actual analysis. \n- the second component is linked to the waste water service level. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_pca |>\n  tidy(4) |>\n  filter(component %in% str_glue(\"PC{1:4}\")) |>\n  mutate(component = fct_inorder(component)) |>\n  ggplot(aes(value, terms, fill = terms)) +\n  geom_col(show.legend = FALSE) +\n  facet_wrap(vars(component), nrow = 1) +\n  labs(title = \"what features contribute to waste ratio (per capita)\", y = NULL)\n```\n\n::: {.cell-output-display}\n![](hydrowaste-analysis_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n# conclusion\n\ngenerally the data features describe more on the data source quality. I think, to conduct deeper analysis one would need to join different data set depending if the problem is linked to funding allocation or for fixing plants that are close to sea, and therefore risk of contamination.\n",
    "supporting": [
      "hydrowaste-analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}